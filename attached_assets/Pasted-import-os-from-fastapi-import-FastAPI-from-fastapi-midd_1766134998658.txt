import os
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from openai import OpenAI
from pydantic import BaseModel
from typing import List, Dict

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"], 
    allow_methods=["*"],
    allow_headers=["*"],
)

# GAIL Framework using Docstrings
GOALS = """
You are a professional career assistant.
Your role is to help job seekers tailor their resumes effectively to match job descriptions and to proofread resumes to be grammatically correct.
Be empathetic, encouraging, and maintain a professional tone.
"""

ACTIONS = """
Ensure that the responses are highly relevant to the job seeker's field of interest, emphasizing the skills, experiences, and qualifications that are most pertinent to the specific job description provided.
Please modify the resume to:
- Be ATS-friendly for the given target occupation and job description.
- Reformat the new resume into a consistent format using Times New Roman font.
- Use action verbs wherever possible and sensible.
- Keep the new resume in a readable format that is within or under one-page long.
"""

INFORMATION = """
Be mindful of any items in the memory and make sure that the logic follows in subsequent outputs.
"""

LANGUAGE = """
Respond in this format:
Name: <User's Name>
Industry: <Industry>
Occupation: <Desired Occupation>

Here's your new resume (in markdown) based on the job description and your existing resume:
# <Name in all caps>
<Contact information>
---
## Professional Summary
<Professional summary>
---
## Skills
<Skills>
---
## Experience
<Professional experience>
---
## Education
<Education>
---
## <Recognition or Awards or Certificates>
<Recognition, awards, and/or certificates>
"""

SYSTEM_PROMPT = f"{GOALS}\n{ACTIONS}\n{INFORMATION}\n{LANGUAGE}"

class ResumeRequest(BaseModel):
    occupation: str
    industry: str
    job_description: str
    name: str
    contact: str
    summary: str
    skills: str
    experience: str
    education: str
    awards: str
    history: List[Dict] = []

@app.post("/chat")
async def process_resume(req: ResumeRequest):
    # Retrieve Key from Replit Secrets
    client = OpenAI(api_key=os.environ['DEEPSEEK_API_KEY'], base_url="https://api.deepseek.com")
    
    user_payload = f"""
    Desired Occupation: {req.occupation}
    Industry: {req.industry}
    Job Description: {req.job_description}
    Name: {req.name}
    Contact: {req.contact}
    Summary: {req.summary}
    Skills: {req.skills}
    Experience: {req.experience}
    Education: {req.education}
    Awards/Certificates: {req.awards}
    """
    
    messages = [{"role": "system", "content": SYSTEM_PROMPT}] + req.history
    messages.append({"role": "user", "content": user_payload})
    
    response = client.chat.completions.create(
        model="deepseek-reasoner",
        messages=messages
    )
    
    return {"reply": response.choices[0].message.content}